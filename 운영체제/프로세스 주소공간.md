
### 프로세스 주소 공간

프로세스 주소 공간이란, **운영체제가 각 프로세스에 할당하는 메모리 영역**으로 스택, 힙, 데이터, 텍스트(코드)로 구성된다.

구성 요소는 다음과 같이 저장된다. 
![[Pasted image 20230516204753.png]]

먼저 각 구성요소에 대해 알아보자, 
1. ***Stack 영역
	 = 지역 변수와 함수 호출 컨텍스트가 포함된 영역***
	
	지역 변수의 경우 함수 호출중에 생성되며, 함수가 종료되면 삭제된다.
	함수 호출 컨텍스트란 함수의 매개변수나, 반환 값, 현재 위치가 저장된다.
	
	스택은 기본적으로 LIFO 구조로 구성되어 있어서 접근 속도가 매우 빠르다. 또한, 스택 구조로 구성하게 되면 가장 최근에 들어간 데이터가 먼저 팝업 되는데, 이러한 구조가 함수 호출과 반환을 효율적으로 수행한다.
	
	좀 더 자세히 말하면, 함수를 호출하면 프로세서는 스택에 현재 위치를 Push 하고, 함수를 반환하면 스택에서 Pop한다. 그 후 프로세서는 Pop한 위치로 이동하게 된다. 
	Stack의 구조 덕에 이러한 동작은 O(1)의 시간이 걸리게 된다.
	만약 Heap을 사용하게 되면 O(log n)의 시간이 걸리게 될 것이다.
	
	또한 Stack overflow라는 말을 들어본 적 있을 것이다.
	만약 재귀함수가 너무 깊어진다면, stack에 많은 데이터가 저장될 것이고, 이것이 stack영역을 초과하게되면 Stack overflow가 발생하게 되는것이다. 또한 앞서 말했듯 Stack영역에는 지역변수도 저장이 되기때문에 지역변수가 너무 많이 사용하게 되면 이역시도 Stack overflow를 발생시키게 된다.

2.***Heap 영역
    = 프로그래머가 할당하고 해제할 수 있는 동적 메모리 영역***
    
	malloc() 을 통해서 메모리를 할당하고, free() 를 통해서 해제 한다.
    메모리를 프로그래머가 관리를 해줘야 하다보니, 메모리 누수에 취약하다, 메모리 누수가 발생하면 프로그램 충돌과 같은 문제가 생길 수 있다.
    
    이전에도 언급했지만, Heap영역은 Stack영역보다 느린데, Heap영역에 접근하려면 프로세서가 Heap내에서 메모리 위치를 검색해야하기 때문이다.
    
    Heap에는 상대적으로 큰 데이터, 재사용 가능한 데이터, 추적하기 어려워야하는 데이터, 동적으로 할당된 데이터가 들어간다.
    
> 이때 Stack의 경우는 프로그램이 시작할 때 운영체제에 의해 결정되고, Heap의 경우는 프로그램 실행중에 필요한 양에 따라 결정된다. 
> 
> 또한, Stack은 주로 작은 크기의 데이터를 저장하는데 사용하기 때문에 Heap에 비해 크기가 작은편이다. 하지만 Stack이던, Heap이던 전체 메모리 크기에 비해 작은 영역을 할당 받는다. -> Stack의 경우 스택오버플로우와 같은 문제를 방지 하기 위해 제한하고, Heap도  관리와 성능상의 이유로 적은 영역 할당

3.  ***Data 영역 
    = 전역 및 공유 변수가 포함된 메모리 영역
    
    프로그램의 시작과 함께 할당되며, 종료할 때 소멸 된다.
    Data영역은 또 3가지로 나눌 수 있는데
    1. readonly : const, final, 문자열과 같은 상수 값들이다. ( .rdata 영역)
    2. read & write : 정적변수가 저장되는 공간이다. ( .data 영역 )
    3. 미할당 : 선언은 되었으나 아직 값이 할당 되지 않은 변수들을 저장한다.( = BSS영역)
    

4. ***Code 영역 
    = 프로그램의 코드가 포함된 메모리 영역
    
     코드가수정되면 안되기 때문에 ReadOnly이다.


이렇게 구역을 나누는 이유는 무엇일까.
사실 간단하게 말하면 메모리를 효율적으로 사용하고, 잘 관리하고, 보안을 향상 시키기 위해서이다. 하지만 좀 더 자세하게 알아보자.

1. 메모리 보호
	주소 공간을 나눠서 잘못된 메모리의 침범을 막기 위해서이다.
	좀 더, 자세하게 설명하면 예를 들어 코드 영역과 같이 읽기 전용인 부분과 데이터 영역같은 쓰기 영역을 나눠서 잘못된 접근으로 인한 오류를 막는다. 

2. 메모리 사용량 감소
	데이터를 공유하여 메모리 사용량을 줄인다. 
	즉 데이터 영역과 코드 영역, 힙 영역을 공유한다. 이러한 이유로 Data와 Stack이 분리되었다.
	스택의 경우는 각 스레드 마다 가지고 있기 때문에 공유하지 않는다. 이부분에 대해서는 뒤에 자세히 설명한다.


그렇다면 이제 앞서 말했던 "스택의 경우는 각 스레드 마다 가지고 있기 때문에"를 설명하기 위해 스레드의 주소 공간을 살펴보자

스레드도 스레드 내에서 수행되는 함수의 흐름을 관리하기 위해 스레드 주소 공간을 가진다. 하지만 좀 다른것은, 힙, 데이터, 코드 영역은 서로 공유하기 때문에 실제로는 스택 영역만을 공유한다.
![](https://i.imgur.com/ddTPxpD.png)
